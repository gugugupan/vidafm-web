<%= content_for :title do %>
  <%= @moment["data"]["name"] %>的地图 - VIDA（唯达） - 你我的生活轨迹
<% end -%>

<%= content_for :page_specific_asset do %>
	<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
  <%= javascript_include_tag :richmarker %>
  <!--[if lte IE 7]>
  <style type="text/css">
    #moment_map #container #map-col {
      width: 659px;
      margin: 0;
    }


  </style>
  <![endif]-->
<%  end -%>

<div id="moment_map">
  <div id="bg_white"> </div>
  <%= render :partial => "widgets/header" %>

  <div id="container">
	  <div id="map-col">
    	<div id="map-canvas"></div>
    </div>
    <div id="info-col">
    	
    	<div class="side-row">
        <%= render :partial => "moments/name", :locals => {:moment => @moment['data']} %>
    	</div>
    	<div class="side-row">
    		<%= render :partial => "widgets/moment_info", :locals => {:moment => @moment['data']} %>
    	</div>

      <div class="side-row">
        <%= render :partial => "widgets/participators", :locals => {:moment => @moment['data']} %>
      </div>

      <div class="side-row">
        <%= render :partial => "widgets/download_bar", :locals => {:hide_title => false} %>
      </div>
    </div>




    <script type="text/javascript">
  		window.moment = <%= raw @moment['data'].to_json %>;

  		var map;
      function initialize() {
        var myOptions = {
          zoom: 8,
          center: new google.maps.LatLng(-34.397, 150.644),
          mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        map = new google.maps.Map(document.getElementById('map-col'),
            myOptions);

        setMarkers(map, activities);


        var bounds = new google.maps.LatLngBounds();
        
        _.each(activities, function(e) { 
        	point = new google.maps.LatLng(e.lat, e.lng);
          if (Math.abs(point.lat()) > 0 && Math.abs(point.lng()) > 0)
            bounds = bounds.extend(point);
	      });

	      google.maps.event.addListener(map, 'zoom_changed', function() {
	          zoomChangeBoundsListener = 
	              google.maps.event.addListener(map, 'bounds_changed', function(event) {
	                  if (this.getZoom() > 15 && this.initialZoom == true) {
	                      // Change max/min zoom here
	                      this.setZoom(15);
	                      this.initialZoom = false;
	                  }
	              google.maps.event.removeListener(zoomChangeBoundsListener);
	          });
	      });
	      map.initialZoom = true;
	      map.fitBounds(bounds);
      }



      var activities = moment.items;

      google.maps.event.addDomListener(window, 'load', initialize);


      function setMarkers(map, locations) {
        // Add markers to the map
        var shape = {
            coord: [1, 1, 1, 20, 18, 20, 18 , 1],
            type: 'poly'
        };

        markers = [];
        for (var i = 0; i < locations.length; i++) {

        	var beach = locations[i];
          var markerImageSize = 40;
          var myLatLng = new google.maps.LatLng(beach.lat, beach.lng);
          if (!(Math.abs(myLatLng.lat()) > 0.1) && !(Math.abs(myLatLng.lng()) > 0.1))
            continue;

          marker = new RichMarker({
            position: myLatLng,
            map: map,
            content: '<a href="/moments/' + beach.moment_id + '#id=' + beach.id + '" target="_blank"><img src="' + beach.photo.url_s + '" class="map-marker" /></a>',
            shadow: "" 
          });

          markers.push(marker);
        }

        mcOptions = {
          gridSize: 50,
          maxZoom: 15
        };
        mc = new MarkerClusterer(map, markers, mcOptions);
      }
  	</script>
  </div>
  <%= render :partial => "widgets/footer" %>
</div>